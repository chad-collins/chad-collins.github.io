---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PostsListItem from "../components/PostsListItem.astro";
import PostsList from "../components/PostsList.astro";
import ReviewCard from "../components/ReviewCard.astro";
import Lightbox from "../components/Lightbox.astro";
import Hero from "../components/Hero.astro";
import { SITE_DESCRIPTION, SITE_TITLE } from "../consts";
import logo from "../assets/bbgn.svg";
import { getBlogPosts, getReviews } from "../utils/posts";

const posts = await getBlogPosts(5);
const reviews = await getReviews(3);

const albums = await getCollection("albums");

// Get all images from all albums
const images = import.meta.glob(
	"/src/content/albums/**/*.{jpg,jpeg,png,webp}",
	{ eager: true },
);

// Get photos from published albums
const allPhotos = albums
	.filter((album) => album.data.published === true)
	.flatMap((album) => {
		const albumDir = album.id.replace("/album", "");
		const albumImages = Object.entries(images)
			.filter(([path]) => path.includes(`/${albumDir}/`))
			.filter(([path]) => !path.includes("cover."))
			.map(([path, module]: [string, any]) => ({
				src: module.default,
				albumName: album.data.name,
				albumDate: album.data.date,
				albumSlug: albumDir,
			}));
		return albumImages;
	})
	.sort((a, b) => b.albumDate.valueOf() - a.albumDate.valueOf())
	.slice(0, 6);
---

<BaseLayout title={SITE_TITLE} description={SITE_DESCRIPTION}>
	<Hero
		slot="hero"
		title="Hi, I'm Chad"
		description="I'm a software developer from Ohio. I post about whatever interests me, including media, life, code, and different projects. Read more <a href='/about'>about me</a>."
		logo={logo}
		logoAlt="BBGN Logo"
	/>

	<section>
		<PostsList title="Latest Posts" viewAllHref="/blog">
			{
				posts.map((post) => (
					<li class="list__item">
						<PostsListItem
							title={post.data.title}
							description={post.data.description}
							pubDate={post.data.pubDate}
							tags={post.data.tags}
							href={`/posts/${post.id}/`}
						/>
					</li>
				))
			}
		</PostsList>
	</section>
	<section>
		{
			reviews.length > 0 && (
				<PostsList grid title="Latest Reviews" viewAllHref="/reviews">
					{reviews.map((review) => (
						<li class="list__item">
							<ReviewCard
								title={review.data.title}
								reviewImage={review.data.reviewImage}
								tags={review.data.tags}
								rating={review.data.rating}
								creator={review.data.creator}
								releaseYear={review.data.releaseYear}
								pubDate={review.data.pubDate}
								href={`/posts/${review.id}/`}
							/>
						</li>
					))}
				</PostsList>
			)
		}
	</section>
	<section>
		{
			allPhotos.length > 0 && (
					<div class="list-header">
						<h2>Latest Photos</h2>
						<a href="/albums">View albums â†’</a>
					</div>
					<div class="photos-grid">
						{allPhotos.map((photo, index) => (
							<div class="photo-item">
								<img
									src={photo.src.src}
									alt={photo.albumName}
									class="photo-thumbnail"
									loading="lazy"
									width={photo.src.width}
									height={photo.src.height}
									data-index={index}
								/>
							</div>
						))}
					</div>
			)
		}

		<Lightbox images={allPhotos} />
	</section>
</BaseLayout>

<style>
	section {
		margin-top: 3rem;
	}

	.photos-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
		gap: 1rem;
	}

	.photo-item {
		overflow: hidden;
		border-radius: 8px;
		cursor: pointer;
		transition: transform 0.2s;
	}

	.photo-item:hover {
		transform: scale(1.02);
	}

	.photo-thumbnail {
		width: 100%;
		height: 200px;
		object-fit: cover;
		display: block;
		cursor: pointer;
	}

	@media (max-width: 768px) {
		.photos-grid {
			grid-template-columns: repeat(2, 1fr);
		}
	}
</style>
