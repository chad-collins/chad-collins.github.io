---
import Navigation from "./Navigation.astro";
import ThemeToggle from "./ThemeToggle.astro";
import { SITE_TITLE } from "../consts";
---

<header class="mobile-header" role="banner">
	<button
		class="hamburger"
		aria-label="Toggle menu"
		aria-expanded="false"
	>
		<span></span>
		<span></span>
		<span></span>
	</button>
	<h2><a href="/">{SITE_TITLE}</a></h2>
	<ThemeToggle />
</header>

<!-- Mobile sidebar overlay -->
<div class="mobile-sidebar-overlay"></div>

<!-- Mobile sidebar drawer -->
<div class="mobile-sidebar-drawer">
	<Navigation />
</div>

<style>
	.mobile-header {
		display: flex;
		align-items: center;
		gap: 1rem;
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 20px;
		height: 60px;
		position: static;
	}

	.mobile-header.sticky {
		position: fixed;
		top: -100px;
		left: 0;
		right: 0;
		z-index: 100;
		backdrop-filter: blur(8px);
		transition: top 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		background-color: rgb(var(--bg-secondary));
		border-bottom: 1px solid rgb(var(--border-color));
	}

	.mobile-header.sticky.show {
		top: 0;
	}

	.mobile-header h2 {
		margin: 0;
		font-size: 1.1rem;
		font-weight: 700;
		letter-spacing: -0.02em;
	}

	.mobile-header h2 a {
		color: rgb(var(--text-color));
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.mobile-header h2 a:hover {
		color: rgb(var(--accent));
	}

	.hamburger {
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		gap: 5px;
		background: none;
		border: none;
		padding: 8px;
		cursor: pointer;
		z-index: 101;
		width: 38px;
		height: 38px;
		position: relative;
	}

	.hamburger span {
		width: 22px;
		height: 2px;
		background-color: rgb(var(--text-color));
		transition: all 0.3s ease;
		border-radius: 2px;
		position: absolute;
	}

	.hamburger span:nth-child(1) {
		top: 11px;
	}

	.hamburger span:nth-child(2) {
		top: 18px;
	}

	.hamburger span:nth-child(3) {
		top: 25px;
	}

	.hamburger[aria-expanded="true"] span:nth-child(1) {
		transform: rotate(45deg);
		top: 18px;
	}

	.hamburger[aria-expanded="true"] span:nth-child(2) {
		opacity: 0;
	}

	.hamburger[aria-expanded="true"] span:nth-child(3) {
		transform: rotate(-45deg);
		top: 18px;
	}

	.mobile-sidebar-overlay {
		display: block;
		position: fixed;
		top: 60px;
		left: 0;
		right: 0;
		bottom: 0;
		background-color: rgb(0 0 0 / 50%);
		opacity: 0;
		pointer-events: none;
		transition: opacity 0.3s ease;
		z-index: 998;
	}

	.mobile-sidebar-overlay.open {
		opacity: 1;
		pointer-events: auto;
	}

	.mobile-sidebar-drawer {
		position: fixed;
		top: 60px;
		left: 0;
		bottom: 0;
		width: 280px;
		min-height: calc(100vh - 60px);
		background-color: rgb(var(--bg-color));
		transform: translateX(-100%);
		transition: transform 0.3s ease;
		overflow-y: auto;
		padding: 1.5rem;
		z-index: 999;
		box-shadow: 2px 0 8px rgb(0 0 0 / 10%);
	}

	.mobile-sidebar-drawer.open {
		transform: translateX(0);
	}
</style>

<script>
	function initMobileHeader() {
		let lastScrollY = window.scrollY;
		let ticking = false;
		let scrollDirection = 0;
		const SCROLL_THRESHOLD = 100;
		const STICKY_TRIGGER = 20 * 16; // 20rem in pixels

		const header = document.querySelector(
			".mobile-header",
		) as HTMLElement | null;
		const hamburger = document.querySelector(
			".hamburger",
		) as HTMLButtonElement | null;
		const overlay = document.querySelector(
			".mobile-sidebar-overlay",
		) as HTMLElement | null;
		const drawer = document.querySelector(
			".mobile-sidebar-drawer",
		) as HTMLElement | null;

		if (!header) return;

		// Hamburger menu toggle
		if (hamburger && overlay && drawer) {
			const closeMenu = () => {
				hamburger.setAttribute("aria-expanded", "false");
				overlay.classList.remove("open");
				drawer.classList.remove("open");
				document.body.style.overflow = "";
			};

			hamburger.addEventListener("click", (e) => {
				e.stopPropagation();
				const isOpen =
					hamburger.getAttribute("aria-expanded") === "true";
				hamburger.setAttribute("aria-expanded", (!isOpen).toString());
				overlay.classList.toggle("open");
				drawer.classList.toggle("open");
				document.body.style.overflow = isOpen ? "" : "hidden";
			});

			// Close when clicking the overlay background
			overlay.addEventListener("click", closeMenu);

			// Close when clicking any link in the drawer
			drawer.querySelectorAll("a").forEach((link) => {
				link.addEventListener("click", closeMenu);
			});
		}

		// Sticky header on scroll
		const headerHeight = header.offsetHeight;
		let spacer: HTMLElement | null = null;

		function onScroll() {
			if (!header) return;

			const currentScrollY = window.scrollY;
			const scrollDelta = currentScrollY - lastScrollY;

			if (currentScrollY > STICKY_TRIGGER) {
				if (!header.classList.contains("sticky")) {
					header.classList.add("sticky");

					spacer = document.createElement("div");
					spacer.style.height = `${headerHeight}px`;
					header.parentNode?.insertBefore(spacer, header);
				}

				if (scrollDelta < 0) {
					scrollDirection = Math.max(
						scrollDirection + Math.abs(scrollDelta),
						0,
					);
					if (scrollDirection >= SCROLL_THRESHOLD) {
						header.classList.add("show");
					}
				} else if (scrollDelta > 0) {
					scrollDirection = 0;
					header.classList.remove("show");
				}
			} else if (currentScrollY === 0) {
				header.classList.remove("sticky", "show");

				if (spacer && spacer.parentNode) {
					spacer.parentNode.removeChild(spacer);
					spacer = null;
				}
			}

			lastScrollY = currentScrollY;
		}

		window.addEventListener(
			"scroll",
			() => {
				if (!ticking) {
					window.requestAnimationFrame(() => {
						onScroll();
						ticking = false;
					});
					ticking = true;
				}
			},
			{ passive: true },
		);

		// Close drawer when resizing to desktop
		window.addEventListener("resize", () => {
			if (window.innerWidth >= 1025 && hamburger && overlay && drawer) {
				const isOpen = hamburger.getAttribute("aria-expanded") === "true";
				if (isOpen) {
					hamburger.setAttribute("aria-expanded", "false");
					overlay.classList.remove("open");
					drawer.classList.remove("open");
					document.body.style.overflow = "";
				}
			}
		});
	}

	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", initMobileHeader);
	} else {
		initMobileHeader();
	}

	document.addEventListener("astro:after-swap", initMobileHeader);
</script>
