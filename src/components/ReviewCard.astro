---
import { Image } from 'astro:assets';
import FormattedDate from './FormattedDate.astro';
import Tag from './Tag.astro';
import ReviewStars from './ReviewStars.astro';
import { getTagColor } from '../utils/tags';

interface Props {
	title: string;
	reviewImage?: any;
	tags?: string[];
	rating?: number;
	artist?: string;
	author?: string;
	director?: string;
	releaseYear?: number;
	pubDate: Date;
	href?: string;
	isSticky?: boolean;
}

const { 
	title, 
	reviewImage, 
	tags = [], 
	rating, 
	artist, 
	author, 
	director, 
	releaseYear, 
	pubDate,
	href,
	isSticky = false 
} = Astro.props;

const reviewType = tags.find(tag => tag !== 'review') || tags[0];
const tagLightColor = reviewType ? getTagColor(reviewType, false) : '';
const tagDarkColor = reviewType ? getTagColor(reviewType, true) : '';
const Element = href ? 'a' : 'div';
---

<Element class={`review-card ${isSticky ? 'sticky' : ''}`} href={href} style={`--card-bg: color-mix(in srgb, ${tagLightColor} 8%, transparent); --card-bg-hover: color-mix(in srgb, ${tagLightColor} 16%, transparent); --tag-border: ${tagLightColor}; --tag-border-dark: ${tagDarkColor};`}>
	{reviewImage && (
		<div class="review-card__image">
			<Image 
				src={reviewImage} 
				alt={`Cover art for ${title}`}
				width={400}
				height={200}
				class="review-card__image-img"
			/>
		</div>
	)}
	<div class="review-card__content">
		<div class="review-card__header">
			<h3 class="review-card__title">{title}</h3>
		</div>
		{(artist || author || director) && (
			<p class="review-card__creator">
				<small>
					{artist || author || director}
					{releaseYear && <span class="review-card__year"> â€¢ {releaseYear}</span>}
				</small>
			</p>
		)}
	</div>
	{rating !== undefined && (
		<div class="review-card__footer" style={`--tag-light: ${tagLightColor}; --tag-dark: ${tagDarkColor};`}>
			{reviewType && (
				<div class="review-card__tag-row">
					<div class="review-card__separator"></div>
					<small class="review-card__tag">{reviewType}</small>
					<div class="review-card__separator"></div>
				</div>
			)}
			<div class="review-card__rating">
				<ReviewStars rating={rating} lightColor={tagLightColor} darkColor={tagDarkColor} />
			</div>
		</div>
	)}
</Element>

<style>
	/* Card container */
	.review-card {
		display: flex;
		flex-direction: column;
		min-height: 350px;
		text-decoration: none;
		color: inherit;
		padding: 1rem;
		margin: 0;
		background-color: none;
	}
	
	a.review-card {
		transition: background-color 0.15s ease;
	}
	
	a.review-card:hover {
		background-color: var(--card-bg-hover);
	}
	
	.review-card.sticky {
		position: sticky;
		top: 100px;
	}
	
	:global(.dark) .review-card {
		border-color: var(--tag-border-dark);
	}
	
	/* Image */
	.review-card__image {
		width: 100%;
		height: 200px;
		margin-bottom: 0.75rem;
		overflow: hidden;
	}
	
	.review-card__image-img {
		width: 100%;
		height: 100%;
		object-fit: contain;
		display: block;
	}
	
	/* Content */
	.review-card__content {
		display: flex;
		flex-direction: column;
		flex: 1;
		gap: 0.5rem;
	}
	
	.review-card__header {
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
	}
	
	.review-card__title {
		font-size: 1em;
		font-weight: 600;
		margin: 0;
		line-height: 1.3;
		letter-spacing: -0.01em;
		text-align: center;
	}
	
	.review-card__tag {
		font-size: 0.6em;
		letter-spacing: 0.06em;
		font-weight: 500;
		color: var(--tag-light);
		margin: 0 0.5rem;
	}
	
	:global(.dark) .review-card__tag {
		color: var(--tag-dark);
	}
	
	.review-card__creator {
		font-size: 0.75em;
		color: rgb(var(--gray));
		margin: 0;
		line-height: 1.4;
		text-align: center;
	}
	
	.review-card__year {
		opacity: 0.7;
	}
	
	/* Rating */
	.review-card__rating {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}
	
	.review-card__footer {
		margin-top: auto;
		padding-top: 0.5rem;
		display: flex;
		flex-direction: column;
		gap: 0.25rem;
	}
	
	.review-card__tag-row {
		display: flex;
		align-items: center;
	}
	
	.review-card__separator {
		flex: 1;
		border-bottom: 1px solid var(--tag-light);
		
	}
	
	:global(.dark) .review-card__separator {
		border-color: var(--tag-dark);
	}
	

</style>